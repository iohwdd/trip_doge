<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tripdog.mapper.ChatHistoryMapper">

    <resultMap id="BaseResultMap" type="com.tripdog.model.entity.ChatHistoryDO">
        <id column="id" property="id" jdbcType="VARCHAR"/>
        <result column="conversation_id" property="conversationId" jdbcType="VARCHAR"/>
        <result column="role" property="role" jdbcType="VARCHAR"/>
        <result column="content" property="content" jdbcType="LONGVARCHAR"/>
        <result column="enhanced_content" property="enhancedContent" jdbcType="LONGVARCHAR"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <insert id="insert" parameterType="com.tripdog.model.entity.ChatHistoryDO">
        INSERT INTO t_chat_history ( conversation_id, role, content, enhanced_content, created_at)
        VALUES (#{conversationId}, #{role}, #{content}, #{enhancedContent}, NOW())
    </insert>

    <delete id="deleteById" parameterType="java.lang.String">
        DELETE FROM t_chat_history WHERE id = #{id}
    </delete>

    <update id="updateById" parameterType="com.tripdog.model.entity.ChatHistoryDO">
        UPDATE t_chat_history SET
            conversation_id = #{conversationId},
            role = #{role},
            content = #{content},
            enhanced_content = #{enhancedContent}
        WHERE id = #{id}
    </update>

    <select id="selectById" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT * FROM t_chat_history WHERE id = #{id}
    </select>

    <select id="selectChatHistoryList" resultMap="BaseResultMap">
        SELECT * FROM t_chat_history
        <where>
            <if test="conversationId != null">AND conversation_id = #{conversationId}</if>
            <if test="role != null and role != ''">AND role = #{role}</if>
            <if test="createdAt != null">AND DATE(created_at) = DATE(#{createdAt})</if>
        </where>
        ORDER BY created_at DESC
    </select>

    <select id="selectRecentMessages" resultMap="BaseResultMap">
        SELECT * FROM t_chat_history WHERE conversation_id = #{conversationId} ORDER BY created_at DESC LIMIT #{limit}
    </select>
    <select id="selectAllById" resultType="com.tripdog.model.entity.ChatHistoryDO">
        select * from t_chat_history
        where conversation_id = #{conversationId}
    </select>

    <delete id="deleteByConversationId" parameterType="java.lang.String">
        DELETE FROM t_chat_history WHERE conversation_id = #{conversationId}
    </delete>

</mapper>
